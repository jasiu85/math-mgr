\section{Definicja}

\noindent
Mimo tego, że wprowadziliśmy już
wiele elementów teorii krzywych eliptycznych,
wciąż jeszcze brakuje nam pewnych wiadomości,
aby móc zdefiniować iloczyn Weila.
Ze względu na ograniczoną objętość pracy
przedstawimy je teraz
w bardzo okrojonym ujęciu.

\subsection*{Podgrupy $n$-torsyjne}

\noindent
Zaczniemy od zdefiniowania podgrup grupy na krzywej eliptycznej,
które stanowią dziedzinę iloczynu Weila.

\begin{definition}
Dana jest krzywa eliptyczna $E$
oraz liczba całkowita $n$.
\emph{Mnożenie punktu na krzywej $E$ przez liczbę całkowitą $n$}
to funkcja $[n] \colon E \to E$
określona następująco:
\begin{equation}
[n](P) =
\fundefthree
{\underbrace{P + P + \cdots + P}_{n\textrm{ razy}}}{n > 0}
{\ecident}{n = 0}
{-[-n](P)}{n < 0}
\end{equation}
Wyrażenie $[n](P)$ zapisujemy skrótowo jako $nP$.
\end{definition}

\noindent
Użycie określenia ,,mnożenie'' oraz skrótowego zapisu $nP$
jest zmotywowane przez własności funkcji $[n]$,
które przypominają cechy operacji mnożenia liczb całkowitych.

\begin{fact}
Dla dowolnych punktów $P$ i $Q$ na krzywej eliptycznej $E$
oraz liczb całkowitych $m$ i $n$
zachodzą następujące zależności:
\begin{eqnarray*}
m(P + Q) & = & mP + mQ \\
(m + n)P & = & mP + nP \\
m(-P) & = & -(mP) \\
(-m)P & = & -(mP)
\end{eqnarray*}
\end{fact}

\noindent
Jesteśmy zainteresowani takimi punktami $P$ krzywej,
które spełniają równanie $nP = \ecident$.
Jak nietrudno stwierdzić na podstawie podanych własności mnożenia,
tworzą one grupę.

\begin{definition}
Dana jest krzywa eliptyczna $E$
oraz liczba naturalna $n$.
\emph{Podgrupa $n$-torsyjna na krzywej $E$},
oznaczana symbolem $E[n]$,
to podgrupa grupy na krzywej $E$
złożona ze wszystkich punktów $P$ na krzywej $E$,
które spełniają zależność:
\begin{equation}
nP = \ecident
\end{equation}
Elementy grupy $E[n]$ nazywamy \emph{punktami rzędu $n$ na krzywej $E$}.
\end{definition}

\begin{example}
Rozważmy krzywą $E_1$ nad ciałem $\F(17)$ o parametrach $16$ i $0$.
Wszystkie punkty na tej krzywej są rzędu cztery,
zatem $E_1 = E_1[4]$.
Można sprawdzić,
że grupa na krzywej $E_1$ jest generowana przez punkty $(5, 1)$ i $(13, 5)$
oraz że ma strukturę $(\Z / 4\Z)\times(\Z / 4\Z)$.
Ponadto, podgrupa $2$-torsyjna na krzywej $E_1$
ma strukturę $(\Z / 2\Z)\times(\Z / 2\Z)$
i składa się z czterech punktów:
$\ecident$, $(0, 0)$, $(1, 0)$ i $(16, 0)$.

\noindent
Weźmy teraz krzywą $E_2$ nad ciałem $\F(19)$ o parametrach $14$ i $12$.
Jej podgrupa $3$-torsyjna ma strukturę $(\Z / 3\Z)\times(\Z / 3\Z)$
i jest generowana przez punkty $(3, 10)$ i $(13, 15)$.
\end{example}

\noindent
Podajemy bez dowodu kilka podstawowych własności podgrup $n$-torsyjnych.

\begin{fact}
Dana jest krzywa eliptyczna $E$
oraz liczby naturalne $m$ i $n$.
Jeżeli $m \mid n$, to $E[m] \subset E[n]$.
\end{fact}

\begin{theorem}\label{torsion_subgroup_isomorphic_zn_zn}
Dana jest krzywa eliptyczna $E$ nad ciałem algebraicznie domkniętym $\K$
oraz liczba naturalna $n$.
Jeżeli $\fieldchar(\K) = 0$ lub $\gcd(n, \fieldchar(\K)) = 1$,
to podgrupa $n$-torsyjna $E[n]$ ma rząd równy $n^2$
i jest izomorficzna z grupą $(\Z / n\Z)\times(\Z / n\Z)$.
\end{theorem}

\begin{corollary}
Dana jest krzywa eliptyczna $E$ nad ciałem algebraicznie domkniętym.
Podgrupa $E[1]$ jest trywialna -- składa się tylko z punktu $\ecident$.
Podgrupa $E[2]$ składa się z czterech punktów:
punktu $\ecident$ oraz trzech punktów rzędu dwa.
\end{corollary}

\begin{remark}
Zakładamy od tej pory,
że rozważane podgrupy $n$-torsyjne
to zawsze mają strukturę $(\Z / n\Z) \times (\Z / n\Z)$.
\end{remark}

\subsection*{Pewne szczególne dywizory}

\noindent
Elementy podgrupy $n$-torsyjnej to rozwiązania równania $nQ = \ecident$.
Rozważymy teraz bardziej ogólne równanie $nQ = P$.
Doprowadzi nas to do definicji pewnego rodzaju dywizorów,
które pojawiają się w definicji iloczynu Weila.

\begin{theorem}
Dany jest punkt $P$ rzędu $n$ na krzywej eliptycznej $E$.
Wówczas:
\begin{itemize}
\item istnieje taki punkt $Q_0$ rzędu $n^2$ na krzywej $E$, że $nQ_0 = P$;
\item każdy punkt $Q$ spełniający równanie $nQ = P$
można przedstawić w postaci $Q = Q_0 + R$,
gdzie $R \in E[n]$.
\end{itemize}
\end{theorem}

\begin{proof}
Zgodnie z twierdzeniem \ref{torsion_subgroup_isomorphic_zn_zn}
grupy $E[n]$ i $E[n^2]$ są izomorficzne
odpowiednio z grupami
$(\Z/n\Z)\times(\Z/n\Z)$ i $(\Z/n^2\Z)\times(\Z/n^2\Z)$.
Wystarczy teraz przeanalizować sposób,
w jaki grupa $(\Z/n\Z)\times(\Z/n\Z)$
jest zanurzona w grupie $(\Z/n^2\Z)\times(\Z/n^2\Z)$.
\end{proof}

\begin{corollary}\label{point_division_corollary}
Jest $n^2$ punktów $Q$ na krzywej eliptycznej $E$
spełniających równanie $P = nQ$, gdzie $P \in E[n]$.
Zbiór tych punktów można przedstawić w postaci $\{Q_0 + R \mid R \in E[n]\}$,
gdzie $Q_0$ jest dowolnym takim punktem.
\end{corollary}

\noindent
Rozważania te motywują definicję ,,dzielenia'' punktu.
Takie dzielenie jest podobne do pierwiastkowania liczb zespolonych --
jest niejednoznaczne, ale zbiór wszystkich możliwych wyników dzielenia
przejawia pewną strukturę.
Zbiór ten będziemy reprezentować za pomocą dywizora.

\begin{definition}
Dana jest krzywa eliptyczna $E$
oraz liczba całkowita $n$.
\emph{Dzielenie punktu na krzywej $E$ przez liczbę całkowitą $n$}
to funkcja $[n]^{-1} \colon E[n] \to \Div(E)$
określona następująco:
\begin{equation}
[n]^{-1}(P) = \sum_{nQ = P} \divi{Q}
\end{equation}
\end{definition}

\begin{example}
Niech $(0, 0)$ będzie punktem na krzywej eliptycznej $E_{16,0}(\F(17))$.
Wówczas:
\begin{equation*}
[2]^{-1}((0, 0)) =
    \divi{(4, 3)} + \divi{(4, 14)} + \divi{(13, 5)} + \divi{(13, 12)}
\end{equation*}
Zauważmy też, że zbiór $\{(4, 3), (4, 14), (13, 5), (13, 12)\}$
można przedstawić w postaci
\linebreak $\{(4, 3) + R \mid R \in E_{16,0}(\F(17))[2]\}$.
\end{example}

\noindent
Następujące twierdzenie przedstawia własność tego rodzaju dywizorów,
która będzie nas najbardziej interesować.

\begin{theorem}\label{point_division_divisor_principle_theorem}
Dany jest punkt $P$ rzędu $n$ na krzywej eliptycznej $E$.
Wówczas zachodzi następująca zależność:
\begin{eqnarray*}
[n]^{-1}(P) \sim n^2\divi{\ecident}
\end{eqnarray*}
\end{theorem}

\noindent
Dowód tego twierdzenia poprzedzimy bardzo użytecznym lematem.

\begin{lemma}\label{divi_reduction_lemma}
Dane są punkty $P$ i $Q$ na krzywej eliptycznej $E$.
Wówczas dywizor $\divi{P+Q} - \divi{P} - \divi{Q} + \divi{\ecident}$
jest główny.
\end{lemma}

\begin{proof}
Lemat zachodzi, jeżeli $P = Q$, $P = -Q$, $P = \ecident$ lub $Q = \ecident$.
W przeciwnym przypadku rozważmy funkcję $\frac{r}{s}$,
gdzie $r$ to linia przechodząca przez punkty $(P+Q)$ i $-(P+Q)$,
a $s$ to linia przechodząca przez punkty $P$, $Q$ i $-(P+Q)$.
Jak nietrudno sprawdzić,
$\rdiv(\frac{r}{s}) = \divi{P+Q} - \divi{P} - \divi{Q} + \divi{\ecident}$.
\end{proof}

\begin{corollary}\label{divi_sum_reduction_coro}
Dane są punkty $P$ i $Q$ na krzywej eliptycznej $E$.
Wówczas $\divi{P} + \divi{Q} \sim \divi{P+Q} + \divi{\ecident}$.
\end{corollary}

\noindent
Zauważmy, że z pomocą tego lematu i płynącego z niego wniosku
możemy sformułować metodę redukcji dywizorów
podobną do twierdzenia \ref{divisor_linear_reduction_theorem}.
Ograniczymy się jednak do zastosowania tej metody
do przypadku dywizorów postaci $[n]^{-1}(P)$.

\begin{proof}[Dowód twierdzenia \ref{point_division_divisor_principle_theorem}]
Niech $\alpha$ i $\beta$ oznaczają generatory grupy $E[n]$.
Wybierzmy dowolny punkt $Q \in E[n^2]$ taki, że $P = nQ$
Zgodnie z wnioskiem \ref{point_division_corollary}
dywizor $[n]^{-1}(P)$ możemy zapisać w postaci:
\begin{equation*}
[n]^{-1}(P) = \sum_{k=0}^{n-1} \sum_{l=0}^{n-1} \divi{Q + k\alpha + l\beta}
\end{equation*}
Teraz wielokrotnie zastosujemy wniosek \ref{divi_sum_reduction_coro},
aby zamienić sumę dywizorów na dywizor sumy.
Najpierw $n-1$ razy redukujemy wewnętrzną sumę i otrzymujemy:
\begin{eqnarray*}
\sum_{l=0}^n \divi{Q + k\alpha + l\beta}
& =    & \divi{Q + k\alpha} + \divi{Q + k\alpha + \beta} +
         \sum_{l=2}^{n-1} \divi{Q + k\alpha + l\beta} \\
& \sim & \divi{\ecident} + \divi{2Q + 2k\alpha + \beta} +
         \divi{Q + k\alpha + 2\beta} +
         \sum_{l=3}^{n-1} \divi{Q + k\alpha + l\beta} \\
& \sim & 2\divi{\ecident} + \divi{3Q + 3k\alpha + 3\beta} +
         \divi{Q + k\alpha + 3\beta} +
         \sum_{l=4}^{n-1} \divi{Q + k\alpha + l\beta} \\
& \sim & 3\divi{\ecident} + \divi{4Q + 4k\alpha + 6\beta} +
         \divi{Q + k\alpha + 4\beta} +
         \sum_{l=5}^{n-1} \divi{Q + k\alpha + l\beta} \\
& \sim & \ldots \\
& \sim & (n-1)\divi{\ecident} + \divi{nQ + nk\alpha + \binom{n}{2}\beta}
\end{eqnarray*}
Wynik ten podstawiamy do zewnętrznej sumy,
po czym w analogiczny sposób redukujemy ją $n-1$ razy.
Otrzymujemy:
\begin{eqnarray*}
\sum_{k=0}^n (n-1)\divi{\ecident} +
             \divi{nQ + nk\alpha + \binom{n}{2}\beta}
& \sim & (n^2-1)\divi{\ecident} +
         \divi{n^2Q + n\binom{n}{2}\alpha + n\binom{n}{2}\beta} \\
& \sim & (n^2-1)\divi{\ecident} + \divi{n^2Q} \\
& \sim & n^2\divi{\ecident}
\end{eqnarray*}
\end{proof}

\begin{corollary}
Dywizor $[n]^{-1}(P) - [n]^{-1}(\ecident)$ jest główny.
\end{corollary}

\subsection*{Iloczyn Weila}

\noindent
Dysponujemy już wszystkimi niezbędnymi informacjami,
aby móc podać definicję iloczynu Weila.

\begin{definition}\label{weil_pairing_def}
Dana jest krzywa eliptyczna $E$ nad ciałem $\K$
oraz liczba całkowita $n$.
Niech $P$ będzie dowolnym punktem na krzywej $E$.
Niech $f_P$ będzie funkcją wymierną na krzywej $E$
określoną z dokładnością do niezerowego czynnika stałego
poprzez podanie jej dywizora:
\begin{equation}
\rdiv(f_P) = [n]^{-1}(P) - [n]^{-1}(\ecident)
\end{equation}
Niech funkcja $t_Q\colon E \to E$ będzie określona następująco:
\begin{equation}
t_Q(R) = R + Q
\end{equation}
\emph{Iloczyn Weila} to funkcja
$w\colon E[n] \times E[n] \to \K$
określona następująco:
\begin{equation}\label{weil_pairing_eqn}
w(P, Q) = \left(\frac{f_P \circ t_Q}{f_P}\right)(\ecident)
\end{equation}
\end{definition}

\begin{remark}
Zauważmy, że podana definicja określa nie jedną funkcję,
lecz całą rodzinę funkcji --
po jednej dla każdej liczby całkowitej $n$.
Dalsze rozważania ograniczamy do tych liczb $n$,
które są dodatnie i dla których
grupa $E[n]$ ma strukturę $(\Z / n\Z)\times(\Z / n\Z)$.
\end{remark}

\begin{remark}
Przyjmujemy od tej pory, że zawsze dana jest pewna liczba całkowita $n$
oraz odpowiadający jej iloczyn Weila $w\colon E[n] \times E[n] \to \K$.
\end{remark}

\noindent
Sprawdźmy teraz, że iloczyn Weila jest dobrze określony.

\begin{lemma}\label{weil_pairing_ignore_const_lemma}
Wartość iloczynu Weila nie zależy od wyboru funkcji $f_P$.
\end{lemma}

\begin{proof}
Na mocy wniosku \ref{fun_divi_equiv_to_const_lemma}
dwie funkcje wymierne $f_P$ i $\tilde{f_P}$ o takim samym dywizorze
różnią się o stały niezerowy czynnik,
zatem przyjmijmy, że $f_P = c\tilde{f_P}$.
Podstawiamy tę zależność do wzoru \ref{weil_pairing_eqn} i otrzymujemy:
\begin{eqnarray*}
\frac{f_P \circ t_Q}{f_P}(\ecident)
& = & \frac{(c\tilde{f_P}) \circ t_Q}{c\tilde{f_P}}(\ecident) \\
& = & \frac{c(\tilde{f_P} \circ t_Q)}{c\tilde{f_P}}(\ecident) \\
& = & \frac{\tilde{f_P} \circ t_Q}{\tilde{f_P}}(\ecident)
\end{eqnarray*}
Widzimy stąd, że wartość iloczynu Weila pozostanie taka sama
niezależnie od tego, jakiej funkcji użyjemy,
ponieważ wszystkie one różnią się o czynnik stały,
który pojawia się zarówno w liczniku, jak i w mianowniku.
\end{proof}

\begin{lemma}\label{weil_pairing_same_divi_lemma}
Funkcje $f_P$ i $f_P \circ t_Q$ mają taki sam dywizor.
\end{lemma}

\begin{proof}
Niech $R \in E[n^2]$ będzie dowolnym punktem takim, że $nR = P$.
Zauważmy, że $f_P(S) = 0$ wtedy i tylko wtedy,
gdy $(f_P \circ t_Q)(S - Q) = 0$.
Podobnie, $f_P(S) = \infty$ wtedy i tylko wtedy,
gdy $(f_P \circ t_Q)(S - Q) = \infty$.
Wszystkie miejsca zerowe i bieguny funkcji $f_P$ są jednokrotne.
Dywizor funkcji $f_P \circ t_Q$ możemy w takim razie zapisać
w następującej postaci:
\begin{equation*}
\rdiv(f_P \circ t_Q) =
\sum_{S \in E[n]} \divi{R + S - Q} - \sum_{S \in E[n]} \divi{S - Q}
\end{equation*}
Wykonujemy ,,zamianę zmiennych'' --
w miejsce zmiennej $S$ podstawiamy zmienną $S' = S - Q$.
Zauważmy, że zmiena $S'$ również będzie przebiegać po zbiorze $E[n]$.
Otrzymujemy:
\begin{eqnarray*}
\rdiv(f_P \circ t_Q) =
& = & \sum_{S' \in E[n]} \divi{R + S'} - \sum_{S' \in E[n]} \divi{S'} \\
& = & \rdiv(f_P)
\end{eqnarray*}
\end{proof}

\begin{corollary}\label{weil_pairing_fun_const_coro}
Funkcja $\frac{f_P \circ t_Q}{f_P}$ jest stała i niezerowa.
\end{corollary}

\begin{proof}
Stosujemy twierdzenie \ref{fun_mul_divi_add_theorem}
i udowodniony przed chwilą lemat
do obliczenia dywizora funkcji $\frac{f_P \circ t_Q}{f_P}$
i otrzymujemy:
\begin{equation*}
\rdiv\left(\frac{f_P \circ t_Q}{f_P}\right) =
\rdiv(f_P \circ t_Q) - \rdiv(f_P) = 0
\end{equation*}
Funkcja mająca zerowy dywizor jest stała i niezerowa,
zgodnie z wnioskiem \ref{zero_div_const_fun_coro}.
\end{proof}

\begin{remark}
Wybór punktu $\ecident$ jako argumentu funkcji $\frac{f_P \circ t_Q}{f_P}$
we wzorze \ref{weil_pairing_eqn} był dowolny,
bo funkcja ta i tak jest stała.
Dlatego też czasem będziemy nadużywać notacji i zapisywać
iloczyn Weila jako:
\begin{equation*}
w(P, Q) = \frac{f_P \circ t_Q}{f_P}
\end{equation*}
\end{remark}

\begin{remark}
Iloczyn Weila nie jest funkcją stałą --
współczynnik $c$ w tożsamości $f_P \circ t_Q = cf_P$
może zmieniać się w zależności od punktu $Q$ mimo tego,
że funkcja $f_P \circ t_Q$ zawsze ma taki sam dywizor jak funkcja $f_P$.
\end{remark}

\begin{theorem}
Iloczyn Weila $w(P, Q)$ jest dobrze określony,
tzn. jego wartość zależy tylko od punktów $P$ i $Q$.
\end{theorem}

\begin{proof}
Natychmiastowy na podstawie
lematu \ref{weil_pairing_ignore_const_lemma}
i wniosku \ref{weil_pairing_fun_const_coro}.
\end{proof}

\begin{example}
Policzymy wartość iloczynu Weila
dla punktów $P = (1, 0)$ i $Q = (16, 0)$ rzędu dwa
na krzywej eliptycznej $E_{16,0}(\F(17))$.

\noindent
Zacznijmy od znalezienia funkcji $f_P$.
W tym celu obliczmy dywizory $[2]^{-1}(P)$ i $[2]^{-1}(\ecident)$:
\begin{eqnarray*}
[2]^{-1}(P) 
& = &
\divi{(7, 8)} + \divi{(7, 9)} + \divi{(12, 4)} + \divi{(12, 13)}
\\{}
[2]^{-1}(\ecident)
& = &
\divi{\ecident} + \divi{(0, 0)} + \divi{(1, 0)} + \divi{(16, 0)}
\end{eqnarray*}

\noindent
Zauważmy teraz,
że wielomian $(x - 7)(x - 12)$
ma dywizor równy $[2]^{-1}(P) - 4\divi{\ecident}$,
a wielomian $y$ ma dywizor równy
$[2]^{-1}(\ecident) - 4\divi{\ecident}$.
Iloraz tych dwóch wielomianów ma szukany dywizor,
przyjmijmy zatem, że funkcja $f_P$ jest równa $\frac{(x - 7)(x - 12)}{y}$.

\noindent
Teraz wystarczy wybrać taki punkt $R$,
żeby wartości $f_P(R + Q)$ i $f_P(R)$ były skończone i niezerowe.
Weźmy $R = (10, 2)$.
Wtedy $R + Q = (10, 15)$, zatem $f_P(R + Q) = -4$.
Z kolei $f_P(R) = 4$.
Otrzymujemy $w(P, Q) = 16$.
\end{example}
