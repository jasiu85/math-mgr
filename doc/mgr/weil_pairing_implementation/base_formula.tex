\section{Podstawowy wzór}

\noindent
Algorytm będzie obliczał wartości iloczynu Weila
na podstawie definicji alternatywnej.
Niestety, fragmentem wzoru \ref{weil_pairing_alt_eqn}
jest wyrażenie $\frac{f_Q'}{f_P'}(\ecident)$,
które zawiera elementy niewygodne z obliczeniowego punktu widzenia --
miejsca zerowe i bieguny oraz punkt w nieskończoności.
Dlatego ,,przesuniemy'' licznik i mianownik
we wzorze \ref{weil_pairing_alt_eqn} tak,
aby operować tylko na wartościach skończonych.

\begin{definition}\label{base_formula_def}
Dana jest krzywa eliptyczna $E$ nad ciałem $\K$
oraz punkty $P, Q \in E[n]$.
Niech $R, S \in E$ będą dowolnymi punktami krzywej $E$ takimi,
że punkty $P$, $Q$, $R$, $S$, $P+R$, $Q+S$ i $\ecident$ są parami różne.
Funkcje wymierne $f_P'', f_Q'' \in K(E)$
określamy poprzez podanie ich dywizorów
następująco:
\begin{eqnarray*}
\rdiv(f_P'') & = & n\divi{P+R} - n\divi{R} \\
\rdiv(f_Q'') & = & n\divi{Q+S} - n\divi{S}
\end{eqnarray*}
Określamy funkcję $w''(P, Q)\colon E[n] \to \K$
następującym wzorem:
\begin{equation}\label{base_formula_eqn}
w''(P, Q) = (-1)^n\frac{f_P''(Q+S)}{f_P''(S)}\frac{f_Q''(R)}{f_Q''(P+R)}
\end{equation}
\end{definition}

\begin{remark}
Podobnie jak w przypadku funkcji
$f_P''$ i $f_Q''$ z definicji \ref{weil_pairing_alt_def},
funkcje $f_P''$ i $f_Q''$
są określone z dokładnością do czynnika stałego.
Nie wpływa to na wartość funkcji $w''(P, Q)$.
\end{remark}

\begin{remark}
Ze względu na wybór punktów $R$ i $S$
we wzorze \ref{base_formula_eqn} nie pojawia się zero ani nieskończoność.
\end{remark}

\noindent
Pokażemy teraz, że funkcje $w'(P, Q)$ i $w''(P, Q)$ są równe.
Głównym narzędziem użytym w dowodzie będzie prawo wzajemności Weila.

\begin{theorem}
Dana jest krzywa eliptyczna $E$ oraz punkty $P, Q \in E[n]$.
Wówczas:
\begin{equation}
w'(P, Q) = w''(P, Q)
\end{equation}
\end{theorem}

\begin{proof}
Z postaci dywizorów określających funkcje $f_P''$ i $f_Q''$
łatwo zauważyć, że $f_P'' = f_P' \circ t_R$ oraz $f_P'' = f_Q' \circ t_S$.
Potrzebna nam będzie jednak inna reprezentacja.
Z lematu \ref{divi_reduction_lemma} wiemy,
że dywizor $\divi{P+R} - \divi{P} - \divi{R} + \divi{\ecident}$ jest główny,
podobnie dywizor $\divi{Q+S} - \divi{Q} - \divi{S} + \divi{\ecident}$.
Niech $r_P$ i $r_Q$ będą określone za pomocą tych dywizorów,
to znaczy:
\begin{eqnarray*}
\rdiv(r_P) & = & \divi{P+R} - \divi{P} - \divi{R} + \divi{\ecident} \\
\rdiv(r_Q) & = & \divi{Q+S} - \divi{Q} - \divi{S} + \divi{\ecident}
\end{eqnarray*}
Można teraz sprawdzić,
że $f_P'' = f_P'r_P^n$ oraz $f_Q'' = f_Q'r_Q^n$.

\noindent
Zastosujmy prawo wzajemności Weila do funkcji $f_P'$ i $r_Q$.
Wykorzystamy przy tym własności symbolu lokalnego
oraz to, że punkty $P$, $Q+S$, $Q$, $S$ i $\ecident$ są parami różne.
Otrzymujemy:
\begin{eqnarray}
1
& = & \prod_{T \in E} \lsym{f_P'}{r_Q}{T}
\nonumber \\
& = & \lsym{f_P'}{r_Q}{Q+S}\lsym{f_P'}{r_Q}{Q}      \lsym{f_P'}{r_Q}{S}
      \lsym{f_P'}{r_Q}{P}  \lsym{f_P'}{r_Q}{\ecident}
\nonumber \\
\label{reciprocity_1_eqn}
& = & \frac{1}{r_Q^n(P)}\frac{f_P'(Q+S)}{f_P'(Q)f_P'(S)}
      (-1)^{-n}\left(\frac{f_P'}{r_Q^{-n}}\right)(\ecident)
\end{eqnarray}
W analogiczny sposób stosujemy prawo wzajemności Weila
do funkcji $r_P$ i $f_Q'$:
\begin{eqnarray}
1
& = & \prod_{T \in E} \lsym{r_P}{f_Q'}{T}
\nonumber \\
& = & \lsym{r_P}{f_Q'}{P+R}\lsym{r_P}{f_Q'}{P}       \lsym{r_P}{f_Q'}{R}
      \lsym{r_P}{f_Q'}{Q}  \lsym{r_P}{f_Q'}{\ecident}
\nonumber \\
\label{reciprocity_2_eqn}
& = & r_P^n(Q)\frac{f_Q'(P)f_Q'(R)}{f_Q'(P+R)}
      (-1)^{-n}\left(\frac{r_P^{-n}}{f_Q'}\right)(\ecident)
\end{eqnarray}
Stosujemy prawo wzajemności Weila jeszcze raz do funkcji $h_P$ i $h_Q$:
\begin{eqnarray}
1
& = & \prod_{T \in E} \lsym{r_P}{r_Q}{T}
\nonumber \\
& = & \lsym{r_P}{r_Q}{P+R}
      \lsym{r_P}{r_Q}{P}
      \lsym{r_P}{r_Q}{R}
\nonumber \\
&   & \lsym{r_P}{r_Q}{Q+S}
      \lsym{r_P}{r_Q}{Q}
      \lsym{r_P}{r_Q}{S}
      \lsym{r_P}{r_Q}{\ecident}
\nonumber \\
& = & \frac{r_P(Q+S)}{r_P(S)}
      \frac{r_Q(R)}{r_Q(P+R)}
      \frac{r_P(Q)}{r_Q(P)}
      \left(\frac{r_P}{r_Q}\right)(\ecident)
\end{eqnarray}
Ostatnią równość podnosimy do $n$-tej potęgi i otrzymujemy:
\begin{equation}\label{reciprocity_3_eqn}
1 =
\frac{r_P^n(Q+S)}{r_P^n(S)}
\frac{r_Q^n(R)}{r_Q^n(P+R)}
\frac{r_P^n(Q)}{r_Q^n(P)}
\left(\frac{r_P^n}{r_Q^n}\right)(\ecident)
\end{equation}

\noindent
Dzięki prawu wzajemności Weila lewe strony równości
\ref{reciprocity_1_eqn}, \ref{reciprocity_2_eqn} i \ref{reciprocity_3_eqn}
możemy domnożyć do wzoru \ref{weil_pairing_alt_eqn}
nie zmieniając wyniku.
Otrzymujemy:
\begin{eqnarray*}
w'(P,Q)
& = & \frac{f_P'(Q)}{f_Q'(P)}(-1)^n\left(\frac{f_Q'}{f_P'}\right)(\ecident) \\
& = & \frac{f_P'(Q)}{f_Q'(P)}(-1)^n\left(\frac{f_Q'}{f_P'}\right)(\ecident) \\
&   & \frac{1}{r_Q^n(P)}\frac{f_P'(Q+S)}{f_P'(Q)f_P'(S)}
      (-1)^{-n}\left(\frac{f_P'}{r_Q^{-n}}\right)(\ecident) \\
&   & r_P^n(Q)\frac{f_Q'(P)f_Q'(R)}{f_Q'(P+R)}
      (-1)^{-n}\left(\frac{r_P^{-n}}{f_Q'}\right)(\ecident) \\
&   & \frac{r_P^n(Q+S)}{r_P^n(S)}
      \frac{r_Q^n(R)}{r_Q^n(P+R)}
      \frac{r_P^n(Q)}{r_Q^n(P)}
      \left(\frac{r_P^n}{r_Q^n}\right)(\ecident) \\
& = & \frac{f_P'(Q+S)r_P^n(Q+S)}{f_P(S)r_P^n(S)}
      \frac{f_Q'(R)r_Q^n(R)}{f_Q'(P+R)r_Q^n(P+R)}
      (-1)^n\left(
      \frac{f_P'f_Q'r_P^nr_P^{-n}}{f_Q'f_P'r_Q^nr_Q^{-n}}
      \right)(\ecident) \\
& = & (-1)^n\frac{f_P''(Q+S)}{f_P''(S)}
      \frac{f_Q''}{f_Q''(P+R)} \\
& = & w''(P,Q)
\end{eqnarray*}
\end{proof}
